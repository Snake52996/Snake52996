<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">

<script> (function(){ if(''){ if (prompt('请输入文章密码') !== ''){ alert('似乎有哪里不对呢！花Q!'); history.back(); } } })(); </script>


  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="暴力,树,树算法," />










<meta name="description" content="前些日子在洛谷上写LCA的时候用倍增算法被卡常数了,一气之下就去查了其他的LCA算法,看到tarjan和树剖都能解决这个问题,于是就选择了学习树剖这条(不归之)路. 以上全是废话">
<meta name="keywords" content="暴力,树,树算法">
<meta property="og:type" content="article">
<meta property="og:title" content="树链剖分学习笔记">
<meta property="og:url" content="https://snake.moe/2018/03/25/树链剖分学习笔记/index.html">
<meta property="og:site_name" content="Snake的尽头之塔">
<meta property="og:description" content="前些日子在洛谷上写LCA的时候用倍增算法被卡常数了,一气之下就去查了其他的LCA算法,看到tarjan和树剖都能解决这个问题,于是就选择了学习树剖这条(不归之)路. 以上全是废话">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://img.blog.csdn.net/2018021719364310">
<meta property="og:image" content="http://img.blog.csdn.net/20180325161832248">
<meta property="og:image" content="http://img.blog.csdn.net/2018021719384371">
<meta property="og:image" content="http://img.blog.csdn.net/2018021719384371">
<meta property="og:updated_time" content="2018-03-29T14:18:29.969Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="树链剖分学习笔记">
<meta name="twitter:description" content="前些日子在洛谷上写LCA的时候用倍增算法被卡常数了,一气之下就去查了其他的LCA算法,看到tarjan和树剖都能解决这个问题,于是就选择了学习树剖这条(不归之)路. 以上全是废话">
<meta name="twitter:image" content="http://img.blog.csdn.net/2018021719364310">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://snake.moe/2018/03/25/树链剖分学习笔记/"/>





  <title>树链剖分学习笔记 | Snake的尽头之塔</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Snake的尽头之塔</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">ガーデン・オブ・アヴァロン</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            时间轴
          </a>
        </li>
      
        
        <li class="menu-item menu-item-chat">
          <a href="/chat/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            留言板
          </a>
        </li>
      
        
        <li class="menu-item menu-item-blogroll">
          <a href="/blogroll/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-link"></i> <br />
            
            友情链接
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://snake.moe/2018/03/25/树链剖分学习笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Snake">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Snake的尽头之塔">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">树链剖分学习笔记</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-25T16:10:54+08:00">
                2018-03-25
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/25/树链剖分学习笔记/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/03/25/树链剖分学习笔记/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>前些日子在洛谷上写LCA的时候用倍增算法被卡常数了,一气之下就去查了其他的LCA算法,看到tarjan和树剖都能解决这个问题,于是就选择了学习树剖这条<del>(不归之)</del>路.</p>
<p><del>以上全是废话</del></p>
<a id="more"></a>
<p>我看了很多大犇的博客才终于大概搞明白了树链剖分是个什么逻辑和思路.虽然大犇们写的都很详细了,但对于本蒟蒻来说还是有些不那么容易理解,因此在这里尝试自己重新解释一下树链剖分的思想和具体实现,同时添加一些自己的理解,来帮助理解这个实际上并不困难的算法.</p>
<hr>
<h2 id="树链剖分的基本思想"><a href="#树链剖分的基本思想" class="headerlink" title="树链剖分的基本思想"></a>树链剖分的基本思想</h2><p>树链剖分或许更应该被称作一种思想,就是将一棵树拆分成几个部分,使每个部分内的元素之间都具有一定的联系,从而允许我们对进行过剖分的树利用一些其他的高级数据结构进行一些难以暴力解决的操作,如:</p>
<ul>
<li>将节点x到节点y的最短路径上的所有节点/边的权值加某个值</li>
<li>将以节点x为根的子树中的所有节点/边的权值加某个值</li>
<li>查询节点x到节点y的最短路径上的所有节点/边的权值之和</li>
<li>查询以节点x为根的子树中的所有节点/边的权值之和</li>
<li>(还可以顺便求最近公共祖先LCA)</li>
</ul>
<p>也就是说,树链剖分就如同它的名字一样,就是将树解剖成若干个部分(称为树链),方便后续的操作.</p>
<h2 id="前置知识需求"><a href="#前置知识需求" class="headerlink" title="前置知识需求"></a>前置知识需求</h2><p>在学习树链剖分之前,需要先行掌握如下的知识:</p>
<ul>
<li>树的基本概念</li>
<li>图的基本概念</li>
<li>深度优先搜索(DFS)</li>
<li>线段树(或者树状数组)</li>
</ul>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p>为了完成分解,需要计算几个辅助数组的值.首先定义一些概念(在概念名后面的括号内的是数组名):</p>
<ul>
<li>和普通树相同的概念(不详细解释了)<ul>
<li>父节点(f)</li>
<li>子节点(head)</li>
<li>大小(size)</li>
<li>深度(dep)</li>
</ul>
</li>
<li>额外添加的概念<ul>
<li>重子节点(hson):节点的子节点中具有最大的size的一个(这类节点又称为重节点.<em>特别的,根节点是重节点</em>)</li>
<li>轻子节点:除重子节点以外的所有节点(这类节点又称为轻节点)</li>
<li>重边:连接父节点和重子节点的边</li>
<li>轻边:连接父节点和轻子节点的边(除重边的所有边)</li>
<li>重链:若干重边连接成的链(下文中也会称为树链)</li>
<li>轻链:若干轻边连接成的链</li>
<li>链顶(top):该节点所在的<strong>重链</strong>的顶端节点的<em>序号</em>(请注意,这里的<em>序号</em>与下文将出现的<em>编号</em>有所不同.序号是节点的原始编号,而编号的具体意义将在下文解释.)</li>
</ul>
</li>
</ul>
<p>为了确认自己是不是已经理解了这些概念,这里附上一张图,并给出某些数组在这种情况下的值.其中,重节点将在图中以红色标识,重边以粗线标识,轻边以细线标识.<br><img src="http://img.blog.csdn.net/2018021719364310" alt="示例来自百度百科"></p>
<p><img src="http://img.blog.csdn.net/20180325161832248" alt="表格"></p>
<p>表格似乎生成的有些问题,正在寻找解决方法,先用图片代替了.</p>
<p>值得注意的是,我们所有下标均从1开始,并以0表示不存在.</p>
<p>如果对于任意节点,我们在访问完后优先访问它的重子节点,并将所有节点按照访问顺序编号,将得到这样的一组编号:</p>
<p><img src="http://img.blog.csdn.net/2018021719384371" alt="编号(修改自百度百科图片)"></p>
<p>仔细观察这两张图以及表格,能够发现如下性质:</p>
<ul>
<li>两个节点x,y在同一条重链上,当且仅当top[x]==top[y]</li>
<li>任何一条重链上的点编号连续</li>
<li>以任何一个点为根的子树中的所有点编号连续</li>
</ul>
<p>事实上,这就是树剖得以解决问题的根本.因此,我们引入了一个新值编号(id):从根节点开始,对于任意节点,先访问其重子节点,然后再访问其其他节点所得到的某节点的访问次序编号.正是id具有的连续性,使得我们能够用线段树完成一些操作.</p>
<h2 id="如何使用树剖的结果"><a href="#如何使用树剖的结果" class="headerlink" title="如何使用树剖的结果"></a>如何使用树剖的结果</h2><p>在研究树剖的实现之前,先来看看在树剖完成后如何应用其结果.我们由简到繁的讨论如下几个应用:</p>
<h3 id="将以节点x为根的子树中的所有节点-边的权值加某个值"><a href="#将以节点x为根的子树中的所有节点-边的权值加某个值" class="headerlink" title="将以节点x为根的子树中的所有节点/边的权值加某个值"></a>将以节点x为根的子树中的所有节点/边的权值加某个值</h3><p>我们假设已经实现了一棵线段树,其名称为t(一下应用中均包含此假设).</p>
<p>关于线段树的具体实现请看完整代码或是我关于线段树的学习笔记(暂时还没有).</p>
<p>显然,由于以任何一个点为根的子树中的所有点编号连续,这时只需要对以x的编号为起始点,x子树中编号最大的节点的编号为终止点的区间进行区间修改,就可以完成这个操作了.而由于连续,最大的点的编号就是x编号加上x的大小.因此,修改的区间就是$[id[x],id[x]+size[x])$.</p>
<h3 id="查询以节点x为根的子树中的所有节点-边的权值之和"><a href="#查询以节点x为根的子树中的所有节点-边的权值之和" class="headerlink" title="查询以节点x为根的子树中的所有节点/边的权值之和"></a>查询以节点x为根的子树中的所有节点/边的权值之和</h3><p>同理,只需要对区间进行区间求和就可以完成了,同样是线段树的基本操作.操作区间同样是$[id[x],id[x]+size[x])$.</p>
<h3 id="求两个节点x和y的最近公共祖先-LCA"><a href="#求两个节点x和y的最近公共祖先-LCA" class="headerlink" title="求两个节点x和y的最近公共祖先(LCA)"></a>求两个节点x和y的最近公共祖先(LCA)</h3><p>显然,两个节点之间的最短路径会经过两个节点的最近公共祖先.因此,在研究对两点间最短路径上的操作之前,我们先来看看如何用树链剖分得到的数据求LCA.</p>
<p>显然,如果两个节点在同一条树链上,它们的LCA就是两点中深度较小的节点.这时可以直接得到结果:<code>LCA=dep[x]&gt;dep[y]?y:x</code>.<br>而当两个节点不在同一树链上时,我们就可以利用top迅速的向上跳跃,来到另一条树链上,尽快的使两个节点到达同一条树链上.这也就解释了为什么我们的原则是”对于任意节点,先访问其重子节点,然后再访问其其他节点”:size的大小可以在一定程度上反映这棵子树的高度,将高度最大的一条作为重链可以使这上面的点迅速跳到顶端,减少跳跃次数,提高算法的效率.</p>
<p>需要注意的是,我们应该让跳跃后到达的链顶深度<strong>更大</strong>的点跳跃而另一个点<strong>保持不动</strong>.这样才能保证两个点不会擦肩而过.</p>
<p><img src="http://img.blog.csdn.net/2018021719384371" alt="编号(修改自百度百科图片)"></p>
<p>比如这个例子中,我们若要求点11和12的LCA,我们若首先让11向上跳跃将到达2,而事实上11和12的LCA是6,<em>这时已经不可能再得到正确的结果了</em>.</p>
<p>代码也不难写出:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">lca</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">	<span class="keyword">while</span>(top[x]!=top[y])</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(dep[top[x]]&lt;dep[top[y]]) swap(x,y);</span><br><span class="line">		x=f[top[x]];<span class="comment">//注意这里,top[x]和x仍在同一树链上,要到达另外一条树链需要取top[x]的父节点</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> dep[x]&gt;dep[y]?y:x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码很简单,但是已经足够正确的求解LCA问题了.</p>
<h3 id="将节点x到节点y的最短路径上的所有节点-边的权值加某个值"><a href="#将节点x到节点y的最短路径上的所有节点-边的权值加某个值" class="headerlink" title="将节点x到节点y的最短路径上的所有节点/边的权值加某个值"></a>将节点x到节点y的最短路径上的所有节点/边的权值加某个值</h3><p>我们采用和上面求LCA一样的思路:不断使两个节点向上移动从而逼近,直到两个节点到达同一树链,这时即可一步完成最后一段的操作.</p>
<p>不难想到,为了实现这个操作,我们只需要在每一步移动x点的时候,修改移动经过的点的权值,就可以轻松完成任务了.由于”任何一条重链上的点编号连续”,我们的区间也很好确定:<br>两点在同一条树链上时,操作区间为$[min(id[x],id[y]),max(id[x],id[y])]$;<br>每次移动x点的时候,操作区间为$[id[top[x]],id[x]]$(注意这里左边界不是$id[f[top[x]]]$,因为这个点将在下次被计算)</p>
<p>代码只需要在LCA代码的基础上稍加修改就可以了:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mod_path</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y,<span class="keyword">int</span> v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">while</span>(top[x]!=top[y])</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(dep[top[x]]&lt;dep[top[y]]) swap(x,y);</span><br><span class="line">		t.add(id[top[x]],id[x]+<span class="number">1</span>,v);<span class="comment">//由于个人习惯,我的线段树操作区间是左闭右开区间,因此+1</span></span><br><span class="line">		<span class="comment">//实际的方法参数会更多,这里忽略了次要矛盾,只突出了主要矛盾:操作区间和增加的值</span></span><br><span class="line">		x=f[top[x]];</span><br><span class="line">	&#125;</span><br><span class="line">	t.add(min(id[x],id[y]),max(id[x],id[y])+<span class="number">1</span>,v);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样是很简洁的代码,依然轻松的完成了任务.</p>
<h3 id="查询节点x到节点y的最短路径上的所有节点-边的权值之和"><a href="#查询节点x到节点y的最短路径上的所有节点-边的权值之和" class="headerlink" title="查询节点x到节点y的最短路径上的所有节点/边的权值之和"></a>查询节点x到节点y的最短路径上的所有节点/边的权值之和</h3><p>思路完全同上,只是将方法从修改变为区间求和,设置一个临时变量累加,最后返回.</p>
<p><strong>注意</strong>:如果有要求千万不要忘记取余,否则请估计结果大小开足够大的变量避免溢出.</p>
<p>代码只需要简单修改上面的片段就可以了.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">cal_path</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ans=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(top[x]!=top[y])</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(dep[top[x]]&lt;dep[top[y]]) swap(x,y);</span><br><span class="line">		ans+=t.cal(id[top[x]],id[x]+<span class="number">1</span>);</span><br><span class="line">		x=f[top[x]];</span><br><span class="line">	&#125;</span><br><span class="line">	ans+=t.cal(min(id[x],id[y]),max(id[x],id[y])+<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>依旧简洁.</p>
<h2 id="如何进行树剖"><a href="#如何进行树剖" class="headerlink" title="如何进行树剖"></a>如何进行树剖</h2><p>现在,我们已经看到了树剖所得到的结果能够正确的工作,帮助我们高效的完成之前提到的几种操作.现在,是时候考虑如何计算这些辅助数组的值了.我们同样分为几步考虑.</p>
<h3 id="输入-建树"><a href="#输入-建树" class="headerlink" title="输入/建树"></a>输入/建树</h3><p>一般来讲,树的输入有两种:给出所有边的信息以及根节点的序号,或是给出根节点序号和f数组.无论对于哪一种情况,我们需要进行一次DFS.在这次DFS中,我们可以完成对f,size,dep,hson和head数组的初始化.</p>
<p>我们从根节点开始,对于每一个访问到的节点(记为t),标记t为已访问,将所有与其有边相连的未访问节点(记为to)的父节点设为t(若是第二种情况则可以省略这一步),并将to加入t的head集合中,更新to的dep的值,然后递归的以to为当前节点,继续操作,并在回溯时更新t的size和hson的值.下面是代码,更详细的解释将在代码中以注释的形式进行.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">link_constructor</span><span class="params">(<span class="keyword">int</span> t)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	a[t].size=<span class="number">1</span>;<span class="comment">//以当前节点为根的子树中目前只已知1个节点</span></span><br><span class="line">	visited[t]=<span class="number">1</span>;<span class="comment">//标记为已访问防止重复访问(死循环)</span></span><br><span class="line">	<span class="comment">//这里使用了链表,其细节将在下文出现</span></span><br><span class="line">	edge* tar=temp[t];<span class="comment">//temp用于临时存储边(适用于第一种情况),在输入时完成初始化</span></span><br><span class="line">	<span class="keyword">while</span>(tar!=<span class="literal">NULL</span>)<span class="comment">//直到不再有与当前节点有边相连的节点为止</span></span><br><span class="line">	&#123;</span><br><span class="line">		edge* tt=tar-&gt;next;<span class="comment">//由于之后可能会修改tar指向的结构体中的next指针,预先存储其指向的地址</span></span><br><span class="line">		<span class="keyword">if</span>(!visited[tar-&gt;to])</span><br><span class="line">		&#123;</span><br><span class="line">			a[tar-&gt;to].f=t;<span class="comment">//设置父节点</span></span><br><span class="line">			a[tar-&gt;to].dep=a[t].dep+<span class="number">1</span>;<span class="comment">//设置深度:比父节点深1层</span></span><br><span class="line">			link_constructor(tar-&gt;to);<span class="comment">//递归调用,先完成子节点的构建,以便更新当前节点的值</span></span><br><span class="line">			<span class="keyword">if</span>(a[t].hson==<span class="number">0</span> || a[a[t].hson].size&lt;a[tar-&gt;to].size) a[t].hson=tar-&gt;id;<span class="comment">//若当前节点还没有重子节点或是重子节点不够重,进行更新</span></span><br><span class="line">			a[t].size+=a[tar-&gt;to].size;<span class="comment">//更新当前节点的size,加上以子节点作为根的子树的size</span></span><br><span class="line">			tar-&gt;next=a[t].head;</span><br><span class="line">			a[t].head=tar;<span class="comment">//将子节点加入集合</span></span><br><span class="line">		&#125;</span><br><span class="line">		tar=tt;<span class="comment">//查看下一个与当前节点有边相连的节点</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码同样不长,现在,我们已经完成了f,size,dep,hson的计算,并删除了重边,完成了所有节点的子节点集合.</p>
<h3 id="分割树"><a href="#分割树" class="headerlink" title="分割树"></a>分割树</h3><p>虽然我们首先进行了一次DFS,但是不幸的是,由于不能预先确定重子节点,我们并<strong>不能</strong>在这一次DFS中确定重链,也不能给节点编号.因此我们再进行一次DFS.在这一次DFS中,我们就可以利用上一次DFS中得到的重子节点的数据给节点依照我们规定的原则编号,并确定重链,初始化每个节点的top值.同样,更详细的将在代码中说明.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> Index=<span class="number">0</span>;<span class="comment">//用于编号</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">split_constructor</span><span class="params">(<span class="keyword">int</span> t)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//有关初始化的细节将在下文出现</span></span><br><span class="line">	id[t]=++Index;<span class="comment">//编号</span></span><br><span class="line">	<span class="keyword">if</span>(hson[t])<span class="comment">//如果有重子节点</span></span><br><span class="line">	&#123;</span><br><span class="line">		top[hson[t]]=top[t];<span class="comment">//显然重子节点和其父节点在同一条树链上,拥有共同的链顶</span></span><br><span class="line">		split_constructor(hson[t]);<span class="comment">//优先访问重子节点</span></span><br><span class="line">	&#125;</span><br><span class="line">	edge* tar=head[t];</span><br><span class="line">	<span class="keyword">while</span>(tar!=<span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(tar-&gt;to!=hson[t])<span class="comment">//注意不能重复访问节点</span></span><br><span class="line">		&#123;</span><br><span class="line">			top[tar-&gt;to]=tar-to;<span class="comment">//与父节点不在同一树链上,自己作为自己所在的树链的链顶</span></span><br><span class="line">			split_constructor(tar-&gt;to);</span><br><span class="line">		&#125;</span><br><span class="line">		tar=tar-&gt;next;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这一次DFS中,我们按照之前确定的顺序,利用上一次DFS得到的信息,成功的将节点进行了编号,并且确定了各个节点的top值.这样就完成了对树的分割.</p>
<h3 id="初始化线段树"><a href="#初始化线段树" class="headerlink" title="初始化线段树"></a>初始化线段树</h3><p>最终的操作要有线段树完成,因此还要完成对线段树的初始化.由于所有操作的区间均由节点的<strong>编号</strong>决定,因此用于构造线段树的数组的下标将与节点编号对应.我们采用一种简单而直观的方法完成(或许并不优美):</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> tempval[MAX];<span class="comment">//临时数组,MAX是最大节点数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sgtree_constructor</span><span class="params">(<span class="keyword">int</span> n)</span><span class="comment">//一共n个节点</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;i++) tempval[id[i]]=val[i];<span class="comment">//将序号为i的节点的权值存储在临时数组下标为i的编号的位置</span></span><br><span class="line">	t.build(tempval,<span class="number">1</span>,n+<span class="number">1</span>);<span class="comment">//调用线段树方法进行构造</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样,线段树也构造好了.</p>
<p>至此,各个部分均已完成,下面就只需要将这些部分串联在一起了.</p>
<h3 id="总初始化函数"><a href="#总初始化函数" class="headerlink" title="总初始化函数"></a>总初始化函数</h3><p>只要按照逻辑,依次执行第一次DFS,第二次DFS,线段树初始化就可以了.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">constructor</span><span class="params">(<span class="keyword">int</span> n,<span class="keyword">int</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	f[r]=<span class="number">0</span>;<span class="comment">//根节点没有父节点</span></span><br><span class="line">	dep[r]=<span class="number">1</span>;<span class="comment">//根节点深度为1</span></span><br><span class="line">	link_constructor(r);<span class="comment">//第一次DFS</span></span><br><span class="line">	top[r]=r;<span class="comment">//根节点是自己所在的树链的链顶</span></span><br><span class="line">	split_constructor(r);<span class="comment">//第二次DFS</span></span><br><span class="line">	sgtree_constructor(n);<span class="comment">//初始化线段树</span></span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此,所有初始化已经完成,下面只需要正确的定义变量,正确的完成主函数的逻辑,按照要求处理输入的数据和指令并正确输出就可以了.下面,我们在实际问题中进行尝试.</p>
<h2 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h2><h3 id="P3178-HAOI2015-树上操作"><a href="#P3178-HAOI2015-树上操作" class="headerlink" title="P3178 [HAOI2015]树上操作"></a><a href="https://www.luogu.org/problemnew/show/P3178" target="_blank" rel="noopener">P3178 [HAOI2015]树上操作</a></h3><p>事实上在洛谷是有树链剖分的模板题的,但是首先让我们从这个更简单一点的模板题开始吧(洛谷的模板题比这个要难).<br>这道题是一个纯粹的树剖,没有任何技巧,甚至<em>不需要进行两个点的向上移动操作</em>(一股清流),纯粹是练习逻辑的.那么直接上就好了,像我这样写代码奇丑的人代码量都还算可以.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAX=<span class="number">100010</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sgtree</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">private</span>:</span><br><span class="line">	T tree[MAX&lt;&lt;<span class="number">2</span>];</span><br><span class="line">	T change[MAX&lt;&lt;<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">updata</span><span class="params">(<span class="keyword">int</span> t)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		tree[t]=tree[t&lt;&lt;<span class="number">1</span>]+tree[t&lt;&lt;<span class="number">1</span>|<span class="number">1</span>];</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">pushdown</span><span class="params">(<span class="keyword">int</span> t,<span class="keyword">int</span> l,<span class="keyword">int</span> r)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(!change[t]) <span class="keyword">return</span>;</span><br><span class="line">		<span class="keyword">int</span> t1=t&lt;&lt;<span class="number">1</span>;</span><br><span class="line">		<span class="keyword">int</span> t2=t&lt;&lt;<span class="number">1</span>|<span class="number">1</span>;</span><br><span class="line">		<span class="keyword">int</span> m=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">		tree[t1]+=change[t]*(m-l);</span><br><span class="line">		tree[t2]+=change[t]*(r-m);</span><br><span class="line">		change[t1]+=change[t];</span><br><span class="line">		change[t2]+=change[t];</span><br><span class="line">		change[t]=<span class="number">0</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">(T a[],<span class="keyword">int</span> l,<span class="keyword">int</span> r,<span class="keyword">int</span> t)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(l==r<span class="number">-1</span>) tree[t]=a[l];</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">int</span> m=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">			build(a,l,m,t&lt;&lt;<span class="number">1</span>);</span><br><span class="line">			build(a,m,r,t&lt;&lt;<span class="number">1</span>|<span class="number">1</span>);</span><br><span class="line">			updata(t);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> t,<span class="keyword">int</span> l,<span class="keyword">int</span> r,<span class="keyword">int</span> low,<span class="keyword">int</span> high,T v)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(low&lt;=l &amp;&amp; r&lt;=high)&#123;</span><br><span class="line">			tree[t]+=v*(r-l);</span><br><span class="line">			change[t]+=v;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			pushdown(t,l,r);</span><br><span class="line">			<span class="keyword">int</span> m=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">			<span class="keyword">if</span>(low&lt;m) add(t&lt;&lt;<span class="number">1</span>,l,m,low,high,v);</span><br><span class="line">			<span class="keyword">if</span>(m&lt;high) add(t&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,m,r,low,high,v);</span><br><span class="line">			updata(t);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">T <span class="title">cal</span><span class="params">(<span class="keyword">int</span> t,<span class="keyword">int</span> l,<span class="keyword">int</span> r,<span class="keyword">int</span> low,<span class="keyword">int</span> high)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(low&lt;=l &amp;&amp; r&lt;=high) <span class="keyword">return</span> tree[t];</span><br><span class="line">		pushdown(t,l,r);</span><br><span class="line">		<span class="keyword">int</span> m=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">		T ans=<span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span>(low&lt;m) ans+=cal(t&lt;&lt;<span class="number">1</span>,l,m,low,high);</span><br><span class="line">		<span class="keyword">if</span>(m&lt;high) ans+=cal(t&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,m,r,low,high);</span><br><span class="line">		<span class="keyword">return</span> ans;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line">sgtree&lt;<span class="keyword">long</span> <span class="keyword">long</span>&gt; sgt;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">edge</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">int</span> to;</span><br><span class="line">	edge* next;</span><br><span class="line">	</span><br><span class="line">	edge()</span><br><span class="line">	&#123;</span><br><span class="line">		to=<span class="number">0</span>;</span><br><span class="line">		next=<span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line">edge e[MAX&lt;&lt;<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> n;</span><br><span class="line"><span class="keyword">long</span> <span class="keyword">long</span> val[MAX];</span><br><span class="line"><span class="keyword">long</span> <span class="keyword">long</span> tempval[MAX];</span><br><span class="line"><span class="keyword">int</span> f[MAX];</span><br><span class="line"><span class="keyword">int</span> top[MAX];</span><br><span class="line"><span class="keyword">int</span> id[MAX];</span><br><span class="line"><span class="keyword">int</span> dep[MAX];</span><br><span class="line"><span class="keyword">int</span> hson[MAX];</span><br><span class="line"><span class="keyword">int</span> size[MAX];</span><br><span class="line"><span class="keyword">bool</span> visited[MAX];</span><br><span class="line">edge* temp[MAX];</span><br><span class="line">edge* head[MAX];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> Index=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> coun=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_edge</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	e[coun].to=y;</span><br><span class="line">	e[coun].next=temp[x];</span><br><span class="line">	temp[x]=&amp;e[coun++];</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">tree_con</span><span class="params">(<span class="keyword">int</span> t)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	visited[t]=<span class="number">1</span>;</span><br><span class="line">	size[t]=<span class="number">1</span>;</span><br><span class="line">	</span><br><span class="line">	edge* tar=temp[t];</span><br><span class="line">	<span class="keyword">while</span>(tar!=<span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		edge* n=tar-&gt;next;</span><br><span class="line">		<span class="keyword">int</span>&amp; to=tar-&gt;to;</span><br><span class="line">		<span class="keyword">if</span>(!visited[to])</span><br><span class="line">		&#123;</span><br><span class="line">			f[to]=t;</span><br><span class="line">			dep[to]=dep[t]+<span class="number">1</span>;</span><br><span class="line">			tree_con(to);</span><br><span class="line">			<span class="keyword">if</span>(!hson[t] || size[hson[t]]&lt;size[to]) hson[t]=to;</span><br><span class="line">			size[t]+=size[to];</span><br><span class="line">			tar-&gt;next=head[t];</span><br><span class="line">			head[t]=tar;</span><br><span class="line">		&#125;</span><br><span class="line">		tar=n;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">split_con</span><span class="params">(<span class="keyword">int</span> t)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	id[t]=++Index;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(hson[t])</span><br><span class="line">	&#123;</span><br><span class="line">		top[hson[t]]=top[t];</span><br><span class="line">		split_con(hson[t]);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	edge* tar=head[t];</span><br><span class="line">	<span class="keyword">while</span>(tar!=<span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">int</span>&amp; to=tar-&gt;to;</span><br><span class="line">		<span class="keyword">if</span>(to!=hson[t])</span><br><span class="line">		&#123;</span><br><span class="line">			top[to]=to;</span><br><span class="line">			split_con(to);</span><br><span class="line">		&#125;</span><br><span class="line">		tar=tar-&gt;next;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sgtree_con</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;i++) tempval[id[i]]=val[i];</span><br><span class="line">	sgt.build(tempval,<span class="number">1</span>,n+<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">constructor</span><span class="params">(<span class="keyword">int</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	tree_con(r);</span><br><span class="line">	top[r]=r;</span><br><span class="line">	split_con(r);</span><br><span class="line">	sgtree_con();</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">cal_path</span><span class="params">(<span class="keyword">int</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">long</span> <span class="keyword">long</span> ans=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(top[x]!=<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		ans+=sgt.cal(<span class="number">1</span>,<span class="number">1</span>,n+<span class="number">1</span>,id[top[x]],id[x]+<span class="number">1</span>);</span><br><span class="line">		x=f[top[x]];</span><br><span class="line">	&#125;</span><br><span class="line">	ans+=sgt.cal(<span class="number">1</span>,<span class="number">1</span>,n+<span class="number">1</span>,<span class="number">1</span>,id[x]+<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> m,x,y,flag;</span><br><span class="line">	<span class="keyword">long</span> <span class="keyword">long</span> a;</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">"%d%d"</span>,&amp;n,&amp;m);</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;i++) <span class="built_in">scanf</span>(<span class="string">"%lld"</span>,val+i);</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;n;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">"%d%d"</span>,&amp;x,&amp;y);</span><br><span class="line">		add_edge(x,y);</span><br><span class="line">		add_edge(y,x);</span><br><span class="line">	&#125;</span><br><span class="line">	constructor(<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=m;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">"%d%d"</span>,&amp;flag,&amp;x);</span><br><span class="line">		<span class="keyword">if</span>(flag==<span class="number">1</span>)&#123;</span><br><span class="line">			<span class="built_in">scanf</span>(<span class="string">"%lld"</span>,&amp;a);</span><br><span class="line">			sgt.add(<span class="number">1</span>,<span class="number">1</span>,n+<span class="number">1</span>,id[x],id[x]+<span class="number">1</span>,a);</span><br><span class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span>(flag==<span class="number">2</span>)&#123;</span><br><span class="line">			<span class="built_in">scanf</span>(<span class="string">"%lld"</span>,&amp;a);</span><br><span class="line">			sgt.add(<span class="number">1</span>,<span class="number">1</span>,n+<span class="number">1</span>,id[x],id[x]+size[x],a);</span><br><span class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span>(flag==<span class="number">3</span>)&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"%lld\n"</span>,cal_path(x));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="P3379-【模板】最近公共祖先（LCA）"><a href="#P3379-【模板】最近公共祖先（LCA）" class="headerlink" title="P3379 【模板】最近公共祖先（LCA）"></a><a href="https://www.luogu.org/problemnew/show/P3379" target="_blank" rel="noopener">P3379 【模板】最近公共祖先（LCA）</a></h3><p>是的,是时候报复这道题了!之前能卡我的常数,看看这回用新的方法它还能不能卡住我!</p>
<p>这同样是树链剖分的删减版,虽然需要进行两点上移的操作,但是由于不需要计算权值,我们<strong>不需要</strong>构造线段树,也不需要为节点编号,只需要正确的top数组就可以AC这道题.因此,代码同样不长(虽然不长,但看起来依然很丑).</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAX=<span class="number">500010</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">edge</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> to;</span><br><span class="line">    edge* next;</span><br><span class="line">    </span><br><span class="line">    edge()</span><br><span class="line">    &#123;</span><br><span class="line">        to=<span class="number">0</span>;</span><br><span class="line">        next=<span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">edge e[MAX&lt;&lt;<span class="number">1</span>];</span><br><span class="line">edge* temp[MAX];</span><br><span class="line">edge* head[MAX];</span><br><span class="line"><span class="keyword">int</span> f[MAX];</span><br><span class="line"><span class="keyword">int</span> next[MAX];</span><br><span class="line"><span class="keyword">int</span> size[MAX];</span><br><span class="line"><span class="keyword">int</span> dep[MAX];</span><br><span class="line"><span class="keyword">int</span> top[MAX];</span><br><span class="line"><span class="keyword">int</span> id[MAX];</span><br><span class="line"><span class="keyword">bool</span> visited[MAX];</span><br><span class="line"><span class="keyword">int</span> ecount=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span> t)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    size[t]=<span class="number">1</span>;</span><br><span class="line">    next[t]=<span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    edge* tar=temp[t];</span><br><span class="line">    <span class="keyword">while</span>(tar!=<span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        edge* nn=tar-&gt;next;</span><br><span class="line">        <span class="keyword">if</span>(!visited[tar-&gt;to])</span><br><span class="line">        &#123;</span><br><span class="line">            dep[tar-&gt;to]=dep[t]+<span class="number">1</span>;</span><br><span class="line">            visited[tar-&gt;to]=<span class="number">1</span>;</span><br><span class="line">            f[tar-&gt;to]=t;</span><br><span class="line">            dfs(tar-&gt;to);</span><br><span class="line">            size[t]+=size[tar-&gt;to];</span><br><span class="line">            <span class="keyword">if</span>(!next[t] || size[next[t]]&lt;size[tar-&gt;to]) next[t]=tar-&gt;to;</span><br><span class="line">            tar-&gt;next=head[t];</span><br><span class="line">            head[t]=tar;</span><br><span class="line">        &#125;</span><br><span class="line">        tar=nn;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">split</span><span class="params">(<span class="keyword">int</span> t)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(next[t]!=<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        id[next[t]]=++ecount;</span><br><span class="line">        top[next[t]]=top[t];</span><br><span class="line">        split(next[t]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    edge* tar=head[t];</span><br><span class="line">    <span class="keyword">while</span>(tar!=<span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(tar-&gt;to!=next[t])</span><br><span class="line">        &#123;</span><br><span class="line">            id[tar-&gt;to]=++ecount;</span><br><span class="line">            top[tar-&gt;to]=tar-&gt;to;</span><br><span class="line">            split(tar-&gt;to);</span><br><span class="line">        &#125;</span><br><span class="line">        tar=tar-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">build_tree</span><span class="params">(<span class="keyword">int</span> s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    dep[s]=<span class="number">1</span>;</span><br><span class="line">    visited[s]=<span class="number">1</span>;</span><br><span class="line">    f[s]=<span class="number">0</span>;</span><br><span class="line">    dfs(s);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_split</span><span class="params">(<span class="keyword">int</span> s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    id[s]=<span class="number">0</span>;</span><br><span class="line">    top[s]=s;</span><br><span class="line">    split(s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">total_init</span><span class="params">(<span class="keyword">int</span> s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    build_tree(s);</span><br><span class="line">    init_split(s);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">lca</span><span class="params">(<span class="keyword">int</span> a,<span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(top[a]!=top[b])</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(dep[top[a]]&lt;dep[top[b]]) swap(a,b);</span><br><span class="line">        a=f[top[a]];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dep[a]&gt;dep[b]?b:a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n,x,y,s,m;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%d%d%d"</span>,&amp;n,&amp;m,&amp;s);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n<span class="number">-1</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%d%d"</span>,&amp;x,&amp;y);</span><br><span class="line">        e[i&lt;&lt;<span class="number">1</span>].to=y;</span><br><span class="line">        e[i&lt;&lt;<span class="number">1</span>].next=temp[x];</span><br><span class="line">        temp[x]=&amp;e[i&lt;&lt;<span class="number">1</span>];</span><br><span class="line">        e[i&lt;&lt;<span class="number">1</span>|<span class="number">1</span>].to=x;</span><br><span class="line">        e[i&lt;&lt;<span class="number">1</span>|<span class="number">1</span>].next=temp[y];</span><br><span class="line">        temp[y]=&amp;e[i&lt;&lt;<span class="number">1</span>|<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    total_init(s);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=m;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%d%d"</span>,&amp;x,&amp;y);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,lca(x,y));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样就不会再被这道题卡常数了(虽然和没有使用vector有关,但实际上这种方法依然比使用了同样存储方式的倍增快近300ms).</p>
<h3 id="P3384-【模板】树链剖分"><a href="#P3384-【模板】树链剖分" class="headerlink" title="P3384 【模板】树链剖分"></a><a href="https://www.luogu.org/problemnew/show/P3384" target="_blank" rel="noopener">P3384 【模板】树链剖分</a></h3><p>终于来到了这里.我们已经在之前的两道例题中分别测试了树剖算法的一部分功能,而现在我们要将所有功能组合在一起,用完整版的树剖A掉这道题<del>(“A上去就赢啦!”)</del>.</p>
<p>其实依然很简单,只要将所有功能放进去,写好主函数就已经成功了.(因为代码量变大了,所以代码更丑了)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MAX=<span class="number">100010</span>;</span><br><span class="line"><span class="keyword">int</span> count_edge=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> Index=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> n,pp;</span><br><span class="line"><span class="keyword">bool</span> visited[MAX];</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sgtree</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">private</span>:</span><br><span class="line">	T tree[MAX&lt;&lt;<span class="number">2</span>];</span><br><span class="line">	T change[MAX&lt;&lt;<span class="number">2</span>];</span><br><span class="line">	T p;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">updata</span><span class="params">(<span class="keyword">int</span> t)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		tree[t]=(tree[t&lt;&lt;<span class="number">1</span>]+tree[t&lt;&lt;<span class="number">1</span>|<span class="number">1</span>])%p;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">pushdown</span><span class="params">(<span class="keyword">int</span> t,<span class="keyword">int</span> l,<span class="keyword">int</span> r)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(!change[t]) <span class="keyword">return</span>;</span><br><span class="line">		<span class="keyword">int</span> t1=t&lt;&lt;<span class="number">1</span>;</span><br><span class="line">		<span class="keyword">int</span> t2=t&lt;&lt;<span class="number">1</span>|<span class="number">1</span>;</span><br><span class="line">		<span class="keyword">int</span> m=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">		tree[t1]=(tree[t1]+change[t]*(m-l))%p;</span><br><span class="line">		tree[t2]=(tree[t2]+change[t]*(r-m))%p;</span><br><span class="line">		change[t1]=(change[t1]+change[t])%p;</span><br><span class="line">		change[t2]=(change[t2]+change[t])%p;</span><br><span class="line">		change[t]=<span class="number">0</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(T mo)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		p=mo;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">(T a[],<span class="keyword">int</span> l,<span class="keyword">int</span> r,<span class="keyword">int</span> t)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(l==r<span class="number">-1</span>) tree[t]=a[l]%p;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">int</span> m=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">			build(a,l,m,t&lt;&lt;<span class="number">1</span>);</span><br><span class="line">			build(a,m,r,t&lt;&lt;<span class="number">1</span>|<span class="number">1</span>);</span><br><span class="line">			updata(t);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> t,<span class="keyword">int</span> l,<span class="keyword">int</span> r,<span class="keyword">int</span> low,<span class="keyword">int</span> high,T v)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(low&lt;=l &amp;&amp; r&lt;=high)&#123;</span><br><span class="line">			tree[t]=(tree[t]+v*(r-l))%p;</span><br><span class="line">			change[t]=(change[t]+v)%p;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			pushdown(t,l,r);</span><br><span class="line">			<span class="keyword">int</span> m=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">			<span class="keyword">if</span>(low&lt;m) add(t&lt;&lt;<span class="number">1</span>,l,m,low,high,v);</span><br><span class="line">			<span class="keyword">if</span>(m&lt;high) add(t&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,m,r,low,high,v);</span><br><span class="line">			updata(t);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function">T <span class="title">cal</span><span class="params">(<span class="keyword">int</span> t,<span class="keyword">int</span> l,<span class="keyword">int</span> r,<span class="keyword">int</span> low,<span class="keyword">int</span> high)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(low&lt;=l &amp;&amp; r&lt;=high) <span class="keyword">return</span> tree[t]%p;</span><br><span class="line">		pushdown(t,l,r);</span><br><span class="line">		<span class="keyword">int</span> m=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">		T ans=<span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span>(low&lt;m) ans+=cal(t&lt;&lt;<span class="number">1</span>,l,m,low,high);</span><br><span class="line">		<span class="keyword">if</span>(m&lt;high) ans+=cal(t&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,m,r,low,high);</span><br><span class="line">		<span class="keyword">return</span> ans;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line">sgtree&lt;<span class="keyword">int</span>&gt; sgt;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">edge</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">int</span> id;</span><br><span class="line">	edge* next;</span><br><span class="line">	</span><br><span class="line">	edge()</span><br><span class="line">	&#123;</span><br><span class="line">		id=<span class="number">0</span>;</span><br><span class="line">		next=<span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;e[MAX&lt;&lt;<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">edge* temp[MAX];</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">int</span> id;</span><br><span class="line">	<span class="keyword">int</span> f;</span><br><span class="line">	<span class="keyword">int</span> hson;</span><br><span class="line">	<span class="keyword">int</span> val;</span><br><span class="line">	<span class="keyword">int</span> top;</span><br><span class="line">	<span class="keyword">int</span> dep;</span><br><span class="line">	<span class="keyword">int</span> size;</span><br><span class="line">	edge* head;</span><br><span class="line">	</span><br><span class="line">	node()</span><br><span class="line">	&#123;</span><br><span class="line">		id=<span class="number">0</span>;</span><br><span class="line">		f=<span class="number">0</span>;</span><br><span class="line">		hson=<span class="number">0</span>;</span><br><span class="line">		val=<span class="number">0</span>;</span><br><span class="line">		top=<span class="number">0</span>;</span><br><span class="line">		dep=<span class="number">0</span>;</span><br><span class="line">		size=<span class="number">0</span>;</span><br><span class="line">		head=<span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;a[MAX];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> tempval[MAX];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">link_constructor</span><span class="params">(<span class="keyword">int</span> t)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	a[t].size=<span class="number">1</span>;</span><br><span class="line">	visited[t]=<span class="number">1</span>;</span><br><span class="line">	</span><br><span class="line">	edge* tar=temp[t];</span><br><span class="line">	<span class="keyword">while</span>(tar!=<span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		edge* tt=tar-&gt;next;</span><br><span class="line">		<span class="keyword">if</span>(!visited[tar-&gt;id])</span><br><span class="line">		&#123;</span><br><span class="line">			a[tar-&gt;id].f=t;</span><br><span class="line">			a[tar-&gt;id].dep=a[t].dep+<span class="number">1</span>;</span><br><span class="line">			link_constructor(tar-&gt;id);</span><br><span class="line">			<span class="keyword">if</span>(a[t].hson==<span class="number">0</span> || a[a[t].hson].size&lt;a[tar-&gt;id].size) a[t].hson=tar-&gt;id;</span><br><span class="line">			a[t].size+=a[tar-&gt;id].size;</span><br><span class="line">			tar-&gt;next=a[t].head;</span><br><span class="line">			a[t].head=tar;</span><br><span class="line">		&#125;</span><br><span class="line">		tar=tt;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">split_constructor</span><span class="params">(<span class="keyword">int</span> t)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	a[t].id=++Index;</span><br><span class="line">	<span class="keyword">if</span>(a[t].hson)</span><br><span class="line">	&#123;</span><br><span class="line">		a[a[t].hson].top=a[t].top;</span><br><span class="line">		split_constructor(a[t].hson);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	edge* tar=a[t].head;</span><br><span class="line">	<span class="keyword">while</span>(tar!=<span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(tar-&gt;id!=a[t].hson)</span><br><span class="line">		&#123;</span><br><span class="line">			a[tar-&gt;id].top=tar-&gt;id;</span><br><span class="line">			split_constructor(tar-&gt;id);</span><br><span class="line">		&#125;</span><br><span class="line">		tar=tar-&gt;next;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sgtree_constructor</span><span class="params">(<span class="keyword">int</span> p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	sgt.init(p);</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;i++) tempval[a[i].id]=a[i].val;</span><br><span class="line">	sgt.build(tempval,<span class="number">1</span>,n+<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">major_constructor</span><span class="params">(<span class="keyword">int</span> r,<span class="keyword">int</span> p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	a[r].dep=<span class="number">1</span>;</span><br><span class="line">	link_constructor(r);</span><br><span class="line">	a[r].top=r;</span><br><span class="line">	split_constructor(r);</span><br><span class="line">	sgtree_constructor(p);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mod_xtoy</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y,<span class="keyword">int</span> v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">while</span>(a[x].top!=a[y].top)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(a[a[x].top].dep&lt;a[a[y].top].dep) swap(x,y);</span><br><span class="line">		sgt.add(<span class="number">1</span>,<span class="number">1</span>,n+<span class="number">1</span>,a[a[x].top].id,a[x].id+<span class="number">1</span>,v);</span><br><span class="line">		x=a[a[x].top].f;</span><br><span class="line">	&#125;</span><br><span class="line">	sgt.add(<span class="number">1</span>,<span class="number">1</span>,n+<span class="number">1</span>,min(a[x].id,a[y].id),max(a[x].id,a[y].id)+<span class="number">1</span>,v);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">cal_xtoy</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ans=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(a[x].top!=a[y].top)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(a[a[x].top].dep&lt;a[a[y].top].dep) swap(x,y);</span><br><span class="line">		ans=(ans+sgt.cal(<span class="number">1</span>,<span class="number">1</span>,n+<span class="number">1</span>,a[a[x].top].id,a[x].id+<span class="number">1</span>))%pp;</span><br><span class="line">		x=a[a[x].top].f;</span><br><span class="line">	&#125;</span><br><span class="line">	ans=(ans+sgt.cal(<span class="number">1</span>,<span class="number">1</span>,n+<span class="number">1</span>,min(a[x].id,a[y].id),max(a[x].id,a[y].id)+<span class="number">1</span>))%pp;</span><br><span class="line">	<span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> m,r,x,y;</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">"%d%d%d%d"</span>,&amp;n,&amp;m,&amp;r,&amp;pp);</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;i++) <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;a[i].val);</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;n;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">"%d%d"</span>,&amp;x,&amp;y);</span><br><span class="line">		e[count_edge].id=y;</span><br><span class="line">		e[count_edge].next=temp[x];</span><br><span class="line">		temp[x]=&amp;e[count_edge++];</span><br><span class="line">		</span><br><span class="line">		e[count_edge].id=x;</span><br><span class="line">		e[count_edge].next=temp[y];</span><br><span class="line">		temp[y]=&amp;e[count_edge++];</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	major_constructor(r,pp);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> flag,z;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=m;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">"%d%d"</span>,&amp;flag,&amp;x);</span><br><span class="line">		<span class="keyword">if</span>(flag==<span class="number">4</span>) <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,sgt.cal(<span class="number">1</span>,<span class="number">1</span>,n+<span class="number">1</span>,a[x].id,a[x].id+a[x].size)%pp);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(flag==<span class="number">3</span>)&#123;</span><br><span class="line">			<span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;z);</span><br><span class="line">			sgt.add(<span class="number">1</span>,<span class="number">1</span>,n+<span class="number">1</span>,a[x].id,a[x].id+a[x].size,z);</span><br><span class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span>(flag==<span class="number">2</span>)&#123;</span><br><span class="line">			<span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;y);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"%d\n"</span>,cal_xtoy(x,y)%pp);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="built_in">scanf</span>(<span class="string">"%d%d"</span>,&amp;y,&amp;z);</span><br><span class="line">			mod_xtoy(x,y,z);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>A掉了这道题,就可以说是掌握了树剖的一些皮毛了.下面,再去洛谷寻找带有树链剖分标签的题,开始虐题<del>(被题虐)</del>吧.</p>
<h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>其实树链剖分本身并没有很难.它的逻辑很清晰,过程也极其简单:DFS1,DFS2,再写好线段树,基本就完成了.而难的地方是它衍生出来的花样.如果能够正确的看出来哪里可以用树剖解决,剩下的问题就好解决了.</p>
<p>我是一棵蒟蒻,如果有幸有大犇路过发现我哪里理解的不对,出现了偏差,还请大犇使劲的喷,那也是对我的帮助.谢谢.</p>
<hr>

      
    </div>
    
    
    
	
	<div>
      
         <div class="my_post_copyright"> <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script> <!-- JS库 sweetalert 可修改路径 --> <script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script> <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script> <p><span>本文标题:</span><a href="/2018/03/25/树链剖分学习笔记/">树链剖分学习笔记</a></p> <p><span>文章作者:</span><a href="/" title="访问 Snake 的个人博客">Snake</a></p> <p><span>发布时间:</span>2018年03月25日 - 16:03</p> <p><span>最后更新:</span>2018年03月29日 - 22:03</p> <p><span>原始链接:</span><a href="/2018/03/25/树链剖分学习笔记/" title="树链剖分学习笔记">https://snake.moe/2018/03/25/树链剖分学习笔记/</a> <span class="copy-path" title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://snake.moe/2018/03/25/树链剖分学习笔记/" aria-label="复制成功！"></i></span> </p> <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" title="Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0)">署名-非商业性使用-相同方式共享 4.0 国际</a> 转载请保留原文链接及作者。</p> </div> <script> var clipboard = new Clipboard('.fa-clipboard'); $(".fa-clipboard").click(function(){ clipboard.on('success', function(){ swal({ title: "", text: '复制成功', icon: "success", showConfirmButton: true }); }); }); </script> 
      
	</div>

    

    
      <div>
        
      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/暴力/" rel="tag"><i class="fa fa-tag"></i> 暴力</a>
          
            <a href="/tags/树/" rel="tag"><i class="fa fa-tag"></i> 树</a>
          
            <a href="/tags/树算法/" rel="tag"><i class="fa fa-tag"></i> 树算法</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/03/25/浅谈并查集/" rel="next" title="浅谈并查集">
                <i class="fa fa-chevron-left"></i> 浅谈并查集
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/03/25/读写挂测试&怀疑人生/" rel="prev" title="读写挂测试&怀疑人生">
                读写挂测试&怀疑人生 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  
  
  

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概况
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="Snake" />
            
              <p class="site-author-name" itemprop="name">Snake</p>
              <p class="site-description motion-element" itemprop="description">从尽头眺望世界</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">32</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Snake52996" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:haoxuan0222@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://wpa.qq.com/msgrd?v=3&uin=3481998052&site=qq&menu=yes" target="_blank" title="qq">
                      
                        <i class="fa fa-fw fa-globe"></i>qq</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.luogu.org/space/show?uid=56568" target="_blank" title="Luogu">
                      
                        <i class="fa fa-fw fa-globe"></i>Luogu</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#树链剖分的基本思想"><span class="nav-number">1.</span> <span class="nav-text">树链剖分的基本思想</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#前置知识需求"><span class="nav-number">2.</span> <span class="nav-text">前置知识需求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#基本概念"><span class="nav-number">3.</span> <span class="nav-text">基本概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何使用树剖的结果"><span class="nav-number">4.</span> <span class="nav-text">如何使用树剖的结果</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#将以节点x为根的子树中的所有节点-边的权值加某个值"><span class="nav-number">4.1.</span> <span class="nav-text">将以节点x为根的子树中的所有节点/边的权值加某个值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查询以节点x为根的子树中的所有节点-边的权值之和"><span class="nav-number">4.2.</span> <span class="nav-text">查询以节点x为根的子树中的所有节点/边的权值之和</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#求两个节点x和y的最近公共祖先-LCA"><span class="nav-number">4.3.</span> <span class="nav-text">求两个节点x和y的最近公共祖先(LCA)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#将节点x到节点y的最短路径上的所有节点-边的权值加某个值"><span class="nav-number">4.4.</span> <span class="nav-text">将节点x到节点y的最短路径上的所有节点/边的权值加某个值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查询节点x到节点y的最短路径上的所有节点-边的权值之和"><span class="nav-number">4.5.</span> <span class="nav-text">查询节点x到节点y的最短路径上的所有节点/边的权值之和</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何进行树剖"><span class="nav-number">5.</span> <span class="nav-text">如何进行树剖</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#输入-建树"><span class="nav-number">5.1.</span> <span class="nav-text">输入/建树</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分割树"><span class="nav-number">5.2.</span> <span class="nav-text">分割树</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化线段树"><span class="nav-number">5.3.</span> <span class="nav-text">初始化线段树</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总初始化函数"><span class="nav-number">5.4.</span> <span class="nav-text">总初始化函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#例题"><span class="nav-number">6.</span> <span class="nav-text">例题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#P3178-HAOI2015-树上操作"><span class="nav-number">6.1.</span> <span class="nav-text">P3178 [HAOI2015]树上操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#P3379-【模板】最近公共祖先（LCA）"><span class="nav-number">6.2.</span> <span class="nav-text">P3379 【模板】最近公共祖先（LCA）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#P3384-【模板】树链剖分"><span class="nav-number">6.3.</span> <span class="nav-text">P3384 【模板】树链剖分</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#后记"><span class="nav-number"></span> <span class="nav-text">后记</span></a></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
	  
	  
	  <br />
	  <h4 class="ui top attached block header">一言（ヒトコト）</h4>
	  <br />
	  <div id="hito" style="font-size: 1em; line-height: 1.5em;"></div>
	  <script src="/js/src/jquery-3.3.1.js"></script>
	  <script type="text/javascript">
		var a_idx = 0;
        var a = new Array("宣纸泛黄，时间流逝，即使眨眼即过，也要抓住那瞬间的辉煌。",
						  "我们一路奋战，不是为了改变世界，而是为了不让世界改变我们。",
						  "(」・ω・)」うー！(／・ω・)／にゃー！",
						  "即使你忘记了我，我也不会遗忘你。",
						  "因为喜欢你，所以想继续相信下去。",
						  "正是因为这一点一滴觉得还有希望的自己，才是最无可救药的吧。",
						  "也许正义并非太阳，而是如同星星一般的东西，天空中有无数的星星，彼此不断抵消着其他星星的光芒。",
						  "真正的坚强，是看到曾经的同伴都留在了远方，向你招手，转过身，继续前行。",
						  "我不相信人类......但是，我相信人类的“可能性”",
						  "正是在对未来没有任何希望的时候，一个人能坚持到什么地步，才真正体现出这个人有多坚强。",
						  "我们虽然距离很远很远，非常非常的远，但是思念或许真的可以穿越时间和距离。",
						  "无法飞翔的翅膀也是有意义的，因为它是曾经翱翔于天空所留下的珍贵回忆。",
						  "虚伪的眼泪，会伤害别人，虚伪的笑容，会伤害自己。",
						  "伤害别人的人，就要有被伤害的觉悟！",
						  "有阳光的地方就会有阴影，所以有阴影的地方也一定会有阳光。绝望的颜色越是浓厚，在哪里也一定会存在耀眼的希望之光。",
						  "正因生来一无所有，因此我们能拥有一切。"
						  ); 
		/*TODO:添加标签,实现对一类需要特殊展示的进行特殊展示*/
		/*TODO:换用更优美的存储方式*/
		a_idx = Math.floor(Math.random() * a.length);
		var temp_text=a[a_idx];
		var set_style="font-size: ";
		if(temp_text=="(」・ω・)」うー！(／・ω・)／にゃー！"){
			set_style=set_style+"0.75em; line-height: 1.5em;";
		}else{
			set_style=set_style+"1em; line-height: 1.5em;";
		}
		$(document).ready(function(){
		$(hito).text(temp_text);
		$(hito).attr("style",set_style);
		});
	  </script>
	  
	  
	  
	  
    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Snake</span>

  
</div>



<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客共计30.0k字</span>
</div>
        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>
  <script src="/js/src/jquery-3.3.1.js"></script>
  <script type="text/javascript">
/* 鼠标特效 */ 
var a_idx = 0;
var seed = 10007;
/*
function randomFrom(lowerValue,upperValue)
{
    return Math.floor(Math.random() * (upperValue - lowerValue + 1) + lowerValue);
}
*/
jQuery(document).ready(function($) { 
    $("body").click(function(e) { 
        var a = new Array("大佬","佩服","%%%","学不来","比不了","强强强","服气","膜拜","我太蒻了","不存在的","谢谢阅读","花Q"); 
		a_idx = Math.floor(Math.random() * a.length);
		var $i = $("<span/>").text(a[a_idx]);
		/*a_idx = (a_idx+((seed*10073486515456548456)+6950848478488968498494894965498654896)%10567)%a.length;*/
		/*alert(10);
		alert(Math.random());
		alert(Math.floor(Math.random() * 255));*/
		/*seed = a_idx;*/
        var x = e.pageX, 
        y = e.pageY;
		var red = Math.floor(Math.random() * 255);
		var green = Math.floor(Math.random() * 255);
		var blue = Math.floor(Math.random() * 255);
		var colour = "rgb("+red.toString()+","+green.toString()+","+blue.toString()+")";
        $i.css({ 
            "z-index": 999999999999999999999999999999999999999999999999999999999999999999999, 
            "top": y - 20, 
            "left": x, 
            "position": "absolute", 
            "font-weight": "bold", 
            /*"color": "rgb(202,200,20)" */
			"color": colour
        }); 
        $("body").append($i); 
        $i.animate({ 
            "top": y - 180, 
            "opacity": 0 
        }, 
        1500, 
        function() { 
            $i.remove(); 
        }); 
    }); 
}); 
</script>
  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'aohaPtjPkpmHIBWXC0o1leb3-gzGzoHsz',
        appKey: 'YyTkR41sQrR4KCpQKaf88XpC',
        placeholder: '王の話をするとしよう!',
        avatar:'mm',
        guest_info:guest,
        pageSize:'20' || 10,
    });
  </script>




  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

  
  
</body>
</html>
